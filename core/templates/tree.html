{% extends 'base.html' %}
{% block title %}Network Tree - Network Marketing{% endblock %}
{% block hero_title %}Network Hierarchy{% endblock %}
{% block hero_description %}Visualize your referral network.{% endblock %}
{% block content %}
    <section class="category-section">
        <h2 class="category-title" data-translate="title">Network Tree</h2>
        <form method="GET" class="mb-4" style="max-width: 500px;">
            <div class="input-group">
                <input type="text" name="q" class="form-control" placeholder="Search by username..." value="{{ query|default:'' }}">
                <button type="submit" class="btn btn-primary">Search</button>
            </div>
        </form>
        <div id="tree" class="bg-white p-4 rounded shadow" style="overflow: auto;"></div>
    </section>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const users = [
            { id: "root", parentId: null },
            {% for user in users %}
                {
                    id: "{{ user.username }}",
                    parentId: "{{ user.parent.username|default:'root' }}",
                    position: "{{ user.position }}"
                },
            {% endfor %}
        ];

        const width = 800;
        const height = 600;

        const svg = d3.select("#tree")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .call(d3.zoom().on("zoom", function (event) {
                g.attr("transform", event.transform);
            }));

        const g = svg.append("g");

        const treeData = d3.stratify()
            .id(d => d.id)
            .parentId(d => d.parentId)(users);

        const treeLayout = d3.tree().size([width - 100, height - 100]);
        const root = treeLayout(treeData);

        g.selectAll(".link")
            .data(root.links())
            .enter()
            .append("path")
            .attr("class", "link")
            .attr("d", d3.linkVertical()
                .x(d => d.x)
                .y(d => d.y))
            .attr("fill", "none")
            .attr("stroke", "#555")
            .attr("stroke-width", 2);

        const node = g.selectAll(".node")
            .data(root.descendants())
            .enter()
            .append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.x},${d.y})`);

        node.append("circle")
            .attr("r", 8)
            .attr("fill", d => d.id === "root" ? "transparent" : "#3182bd")
            .style("cursor", "pointer")
            .on("mouseover", function () { d3.select(this).attr("r", 10); })
            .on("mouseout", function () { d3.select(this).attr("r", 8); });

        node.append("text")
            .attr("dy", ".35em")
            .attr("y", -15)
            .attr("text-anchor", "middle")
            .text(d => d.id === "root" ? "" : d.id)
            .style("font-size", "12px")
            .style("fill", "#333");
    </script>
{% endblock %}